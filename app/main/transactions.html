<template>
    <div class="page">
        <div class="navbar">
            <div class="navbar-inner">
                <img class="theme-light-only" src="assets/custom/img/konbini-logo.svg" height="24" alt="" />
            </div>
        </div>
        <div class="page-content" style="padding-top: 44px;">
            <!-- <div class="block">
                <div class="row">
                    <div class="col-25">
                        <div class="item-inner">
                            <div class="item-title item-label">From Date</div>
                            <div class="item-input-wrap">
                                <input type="date" name="fromDate" value="{{startDate}}" />
                            </div>
                        </div>
                    </div>
                    <div class="col-25">
                        <div class="item-inner">
                            <div class="item-title item-label">To Date</div>
                            <div class="item-input-wrap">
                                <input type="date" name="toDate" value="{{endDate}}" />
                            </div>
                        </div>
                    </div>
                    <div class="col-25">
                        <div class="item-inner">
                            <button type="button" @click=search()
                                class="button button-small button-round button-fill">Search</button>
                        </div>
                    </div>
                </div>
            </div> -->
            <div class="block text-align-left"></div>
            <div class="content-block block-card text-align-left">
                <div class="your-cart">All orders</div>
            </div>
            <div class="list">
                <div class="list-group">
                    <ul>
                        {{#each items}}
                        <li>
                            <a href="#" @click="loadDetails('{{this.id}}')" class="item-link">
                                <div class="item-content">
                                    <div class="item-media">
                                        <i class="fa-stack">
                                            <span class="fas fa-circle fa-stack-2x text-color-red"></span>
                                            <span class="fas fa-shopping-cart fa-stack-1x fa-inverse"></span>
                                        </i>
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title">
                                            <span>{{this.orderNumber}}</span>
                                            <div class="item-header">
                                                {{this.orderTime}}
                                            </div>
                                        </div>
                                        <div class="item-title" style="text-align: right;">
                                            <div class="item-header text-color-red">
                                                $ -{{this.totalPrice.toFixed(2)}}
                                            </div>
                                            <span class="badge color-green">{{this.statusName}}</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </li>
                        {{/each}}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</template>
<style>
.fa-stack {
    width: 2em;
}
.your-cart {
        font-size: 25px;
        font-weight: bold;
        letter-spacing: 0.5px;
        margin-top: 0px;
        padding-left: 15px;
    }
</style>
<script>
    return {
        data: function () {
            return {
                transactions: null,
                items: null,
                totalCount: 0,
                startDate: '2000-01-01',
                endDate: '2099-12-31',
            }
        },
        methods: {
            loadData: function (startDate, endDate) {
                var self = this;
                let tempItem = [];
                app.request.getJSON(window.config.url + 'api/services/app/Preorder/GetTransactions',
                //console.log(window.config.url + 'api/services/app/Preorder/GetTransactions?StartDate=' + startDate + '&&EndDate=' + endDate);
                //app.request.getJSON(window.config.url + 'api/services/app/Preorder/GetTransactions?StartDate=' + startDate + '&&EndDate=' + endDate,
                    function (suc) {
                        console.log('suc.result', suc.result)
                        if (startDate != null && endDate != null){
                            let compDate = new Date();
                            for (let i = 0; i < suc.result.items.length; i++){
                                compDate = new Date(suc.result.items[i].orderTime)
                                compDate = compDate.toISOString().substr(0, 10);
                                if (startDate <= compDate && compDate <= endDate){
                                    tempItem.push(suc.result.items[i]);
                                }
                            }
                        }
                        else {
                            tempItem = suc.result.items;
                        }
                        for (let i = 0; i < tempItem.length; i++){
                            let orderTime = new Date(tempItem[i].orderTime);
                            let tempTotalPrice = 0;
                            tempItem[i].orderTime = orderTime.getDate() + "/" + (orderTime.getMonth()+1) + "/" + orderTime.getFullYear() + " " + orderTime.getHours() + ":" + orderTime.getMinutes(); 
                            for (let j = 0; j < tempItem[i].orderItems.length; j++){
                                tempTotalPrice += tempItem[i].orderItems[j].price;
                                console.log(tempTotalPrice)
                            }   
                            tempItem[i].totalPrice = tempTotalPrice;                       
                        }
                        self.$setState({
                            transactions: tempItem,
                            totalCount: suc.result.totalCount,
                            items: tempItem
                        });
                        console.log(tempItem)                       
                    },
                    function (err) {
                        console.log(err)
                    })
            },
            loadDetails: function (id){
                let self = this;
                let det = self.items.find(function (el) {
					return el.id == id;
				})
                localStorage.setItem('detTransactions', JSON.stringify(det))
                app.views.current.router.navigate('/transactions-detail');
            },
            groupItems: function (list) {
                list.forEach(element => {
                    // get time offset from browser
                    var currentDate = new Date();
                    var offset = -(currentDate.getTimezoneOffset() / 60);
                    // get provided date
                    let givenDate = new Date(element.creationTime);
                    // apply offset
                    var hours = givenDate.getHours();
                    hours += offset;
                    givenDate.setHours(hours);
                    // format the date
                    element.creationTime = ("0" + givenDate.getDate()).slice(-2) + '/' + ("0" + (givenDate.getMonth() + 1)).slice(-2) + '/' + givenDate.getFullYear() + ' ' + ("0" + givenDate.getHours()).slice(-2) + ':' + ("0" + givenDate.getMinutes()).slice(-2);
                    //convert amount: cent>>dollar
                    element.amount = element.amount / 100;
                });

                result = list.reduce(function (r, a) {
                    r[a.creationTime.substr(3, 7)] = r[a.creationTime.substr(3, 7)] || [];
                    r[a.creationTime.substr(3, 7)].push(a);
                    return r;
                }, Object.create(null));

                return result;
            },
            search: function () {
                var self = this;
                let fromDate = self.$('input[name=fromDate]').val();
                let toDate = self.$('input[name=toDate]').val();
                self.loadData(fromDate, toDate)
            },
            getId: function (id) {
                var self = this;
                console.log(id)
            }
        },
        mounted() {
            var self = this;
            let dt = new Date();
            self.endDate = dt.toISOString().substr(0, 10);
            let dat = new Date();
            dat.setDate(1);
            self.startDate = dat.toISOString().substr(0, 10);
            self.loadData();
        }
    }
</script>