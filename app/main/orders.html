<template>
	<div class="page no-swipeback">
		<div class="navbar">
			<div class="navbar-inner">
				<img class="theme-light-only" src="assets/custom/img/konbini-logo.svg" height="24" alt="" />
				<div class="right">
					<a href="/orders-cart" class="link icon-only">
						<i class="icon material-icons">shopping_cart<span
								class="badge color-red">{{cartItems.quantity}}</span></i></a>
					<span class="text-color-red">$ {{cartItems.total.toFixed(2)}}</span>
				</div>
				<div class="subnavbar">
					<div class="subnavbar-inner" style="justify-content: center;">
						<a href="#" @click="prev" class="item-link">
							<i class="fas fa-caret-left" style="margin-right: 8px"></i>
						</a>
						<div class="item-input-wrap">
							<input type="text" value="{{today}}" readonly="readonly" id="date" style="width: 6rem;" />
						</div>
						<a href="#" @click="next" class="item-link">
							<i class="fas fa-caret-right" style="margin-left: 8px"></i>
						</a>
						<div class="item-input-wrap input-dropdown-wrap" style="margin-left: 0.5rem">
							<select name="session">
								{{#if session}}
								{{#each session}}
								<option value="{{this.id}}">{{this.name}}: {{this.startTime}}-{{this.endTime}}</option>
								{{/each}}
								{{/if}}
							</select>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="page-content">
			{{#if categories}}
			<div class="toolbar tabbar tabbar-scrollable tabbar-sticky" style="margin-top: 44px;">
				<div class="toolbar-inner categoriesFont">
					<a href="#" id="undefined" class="cat-link tab-link-active" style="margin-left: 10px"
						@click="selectCat(undefined)">ALL</a>
					{{#each categories}}
					<a href="#" id="{{this.id}}" class="cat-link" style="margin-left: 10px"
						@click="selectCat('{{this.id}}')">{{this.name}}</a>
					{{/each}}
				</div>
			</div>
			<div class="list media-list no-hairlines no-hairlines-between margin-vertical descriptionFont">
				<ul>
					{{#if productList}}
					{{#each productList}}
					<li>
						<div class="item-content">
							<div class="item-media"><img
									src="https://wokpplapi.konbi.cloud/uploads/{{this.imageFileName}}" width="80" />
							</div>
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title">{{this.name}}</div>
									<div class="item-title" style="font-weight: bold;">
										$ {{this.price.toFixed(2)}}</div>
								</div>
								<div class="item-subtitle">{{#each this.categories}}
									{{this.name}}
									{{/each}}
								</div>
								<div class="item-row">
									<div class="item-text">{{this.description}}
									</div>
									<div class="item-after" style="color: red; font-weight: bold;">
										<a href="#" @click="selectOption('{{this.id}}')" class="item-link tooltip-init"
											data-tooltip="Add to Cart">
											<i class="fas fa-fw fa-lg fa-cart-plus text-color-red"></i></a>
									</div>
								</div>
							</div>
						</div>
					</li>
					{{/each}}
					{{/if}}
				</ul>

			</div>
			{{/if}}

		</div>
</template>

<style scoped>
</style>

<script>
	return {
		data: function () {
			return {
				today: null,
				tempQuantity: 0,
				session: null,
				categories: null,
				allProducts: null,
				productList: null,
				detail: null,
				selected: undefined,
				cartItems: {
					quantity: 0,
					total: 0.00,
					items: []
				},
				listOrderDate: null,
				listOrderSession: null,
			}
		},
		methods: {
			formatDate: function (date, langCode) {
				var day = date.toLocaleString(langCode, { day: '2-digit' });   // DD
				var month = date.toLocaleString(langCode, { month: '2-digit' }); // MM
				var year = date.toLocaleString(langCode, { year: 'numeric' }); // YYYY
				console.log('year', year)
				return `${day}/${month}/${year}`;
			},
			prev: function () {
				var self = this;
				let now = new Date();
				let dt = $('#date').val();
				console.log('now', now.toLocaleDateString())
				console.log('dt', dt)
				if (dt != self.formatDate(now, 'en')) {
					let arr = dt.split('/');
					dt = arr[2] + '/' + arr[1] + '/' + arr[0]
					let date = new Date(dt);
					date.setTime(date.getTime() - (1000 * 60 * 60 * 24))
					self.$setState({
						today: self.formatDate(date, 'en')
					});
				}
				self.updateProducts();
			},
			next: function () {
				var self = this;
				let dt = $('#date').val();
				let arr = dt.split('/');
				console.log('dt1', dt)
				dt = arr[2] + '/' + arr[1] + '/' + arr[0]
				console.log('dt2', dt)
				let date = new Date(dt);
				date.setTime(date.getTime() + (1000 * 60 * 60 * 24))
				console.log('date', date)
				self.$setState({
					today: self.formatDate(date, 'en')
				});
				self.updateProducts();
			},
			selectOption: function (id) {
				var self = this;
				let orderDate = $('#date').val();
				let orderSession = self.$('select[name=session]').val();
				console.log(id);
				let det = self.productList.find(function (el) {
					return el.id == id;
				})
				localStorage.setItem('addProduct', JSON.stringify(det))
				self.$setState({
					detail: det,
					tempQuantity: self.tempQuantity + 1,
				})
				//console.log(self.detail)
				self.listOrderDate = orderDate;
				for (let i = 0; i < self.session.length; i++) {
					if (orderSession == self.session[i].id) {
						self.listOrderSession = self.session[i];
					}
				}
				localStorage.setItem('listOrderDate', JSON.stringify(self.listOrderDate));
				localStorage.setItem('listOrderSession', JSON.stringify(self.listOrderSession));
				app.views.current.router.navigate('/orders-options');
			},
			selectCat: function (selected) {
				var self = this;

				$('a').attr('id', function (i, id) {
					if (id == selected) {
						$('a[id=' + id + ']').addClass('tab-link-active');
					}
					else
						$('a[id=' + id + ']').removeClass('tab-link-active');
				})

				let sess = self.$('select[name=session]').val();
				let arr = $('#date').val().split('/');
				let dateInput = arr[1] + '/' + arr[0] + '/' + arr[2]
				if (selected == undefined) {
					// self.loadProduct(dateInput, sess, '')
					self.$setState({
						productList: self.allProducts
					})

				}
				else {
					// self.loadProduct(dateInput, sess, selected);
					self.$setState({
						productList: self.allProducts.filter(function (el) {
							for (let i = 0; i < el.categories.length; i++) {
								return el.categories[i].id == selected
							}
						})
					})
				}

			},
			loadSession: function () {
				var self = this;
				app.request.get(window.config.url + 'api/services/app/Preorder/GetSessions',
					function (suc) {
						let response = JSON.parse(suc)
						console.log('get session success', response)
						self.$setState({
							session: response.result.items
						})
					},
					function (err) {
						console.log('get session error', err)
					})
			},
			loadCategory: function () {
				var self = this;
				app.request.get(window.config.url + 'api/services/app/Preorder/GetCategories',
					function (suc) {
						let response = JSON.parse(suc)
						console.log('get category success', response)
						self.$setState({
							categories: response.result.items
						})
					},
					function (err) {
						console.log('get category error', err)
					})
			},
			loadProduct(date, sessionId, categoryId) {
				var self = this;
				console.log(categoryId)
				app.request.get(window.config.url + 'api/services/app/Preorder/GetProductMenuBrowsingList',
					{
						Date: date, SessionId: sessionId, CategoryId: categoryId
					},
					function (suc) {
						let response = JSON.parse(suc)
						console.log('get product success', response)
						self.$setState({
							allProducts: response.result.items,
							productList: response.result.items,
						})
						console.log('ABC: ', self.productList)
					},
					function (err) {
						console.log('get product error', err)
					})
			},
			updateProducts: function () {
				var self = this;
				let sess = self.$('select[name=session]').val();
				let arr = $('#date').val().split('/');
				let dt = arr[1] + '/' + arr[0] + '/' + arr[2]
				$('a').attr('id', function (i, id) {
					if (id == undefined) {
						$('a[id=' + id + ']').addClass('tab-link-active');
					}
					else
						$('a[id=' + id + ']').removeClass('tab-link-active');
				})
				self.loadProduct(dt, sess, '')
			}
		},
		mounted() {
			localStorage.removeItem('isEdit');
			var self = this;
			let date = new Date();
			let dateInput = (date.getMonth() + 1) + '/' + date.getDate() + '/' + date.getFullYear();
			console.log(dateInput);
			
			self.$setState({
				today: self.formatDate(date, 'en'),
				//cartItems: JSON.parse(localStorage.getItem('cartItems')) == undefined ? { quantity: 0, total: 0.00, items: [] } : JSON.parse(localStorage.getItem('cartItems')),
				session: JSON.parse(localStorage.getItem('sessions')),
				categories: JSON.parse(localStorage.getItem('categories'))
			});
			setTimeout(function () {
				console.log('timeout')
				self.$setState({
					//today: self.formatDate(date, 'en'),
					cartItems: JSON.parse(localStorage.getItem('cartItems')) == undefined ? { quantity: 0, total: 0.00, items: [] } : JSON.parse(localStorage.getItem('cartItems')),
					//session: JSON.parse(localStorage.getItem('sessions')),
					//categories: JSON.parse(localStorage.getItem('categories'))
				});
			});
			console.log('test', self.cartItems)
			var calendarDateFormat = app.calendar.create({
				inputEl: '#date',
				dateFormat: 'dd/mm/yyyy',
				minDate: new Date(),
				closeOnSelect: true
			});

			self.loadSession();
			// self.loadCategory();
			self.loadProduct(dateInput, self.session[0].id, '');

			self.$('select[name=session]').change(function () {
				self.updateProducts();
			})

			self.$('#date').change(function () {
				self.updateProducts();
			})
			// $('#tab-order').on('tab:show', function () {
			// 	app.views.current.router.refreshPage();
			// });
		},
		on: {
			pageInit: function () {
				console.log('pageInit')
			}
		}
	}
</script>