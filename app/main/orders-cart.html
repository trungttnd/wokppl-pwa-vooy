<template>
    <div class="page">
        <div class="navbar">
            <div class="navbar-inner">
                <img class="theme-light-only" src="assets/custom/img/konbini-logo.svg" height="24" alt="" />
                <div class="right">
                    <!-- <a href="/orders-cart" class="link icon-only">
                        <i class="icon material-icons">shopping_cart<span
                                class="badge color-red">{{quantity}}</span></i></a>
                    <span class="text-color-red">${{total.toFixed(2)}}</span> -->
                </div>
            </div>
        </div>

        <div class="page-content">
            <div class="block text-align-left"></div>
            <div class="content-block block-card text-align-left">
                <div class="your-cart">Order Details:</div>
            </div>
            <div class="card">
                <div class="card-content card-content-padding">
                    <div class="list no-hairlines no-hairlines-between">
                        <ul>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Order Date: {{listOrderDate}}</div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Session: {{orderSessionName}}</div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Collection Time:
                                            <!-- <input type="text" id="timepicker-24" placeholder="Select" readonly /> -->
                                        </div>
                                        <div class="item-input">
                                            <input type="text" placeholder="Select" readonly="readonly" id="timepicker-24"/>
                                            <!-- <input type="text" id="timepicker-24" placeholder="Select" readonly /> -->
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Receive Method: &nbsp;
                                            <label class="radio">
                                                <input type="radio" name="radio" value="3" checked/>
                                                <i class="icon-radio"></i>
                                            </label>
                                            &nbsp;Dine In&nbsp;&nbsp;
                                            <label class="radio color-red">
                                                <input type="radio" name="radio" value="2"/>
                                                <i class="icon-radio"></i>
                                            </label>
                                            &nbsp;Take Away
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="block text-align-left"></div>
            <div class="content-block block-card text-align-left">
                <div class="your-cart">Your Cart:</div>
            </div>
            <div class="card">
                <div class="list media-list no-hairlines no-hairlines-between margin-vertical descriptionFont">
                    <ul>
                        {{#if productList}}
                        {{#each productList}}
                        <li>
                            <div class="item-content">
                                <div class="item-media"><img
                                        src="https://wokpplapi.konbi.cloud/uploads/{{this.imageFileName}}" width="80" />
                                </div>
                                <div class="item-inner">
                                    <div class="item-title-row">
                                        <div class="item-title">{{this.name}}</div>
                                        <div class="item-title">
                                            ${{this.price.toFixed(2)}} x {{this.orderQuantity}}</div>
                                    </div>
                                    <div class="item-text">
                                        <div class="row">
                                            <div class="col-75">
                                                <div class="item-cell">
                                                    {{#each this.modifierGroups}}
                                                    <div class="item-row">
                                                        {{this.name}}: {{#each this.modifiers}} {{#if this.isChoose}}
                                                        {{this.name}} {{/if}} {{/each}}
                                                    </div>
                                                    {{/each}}
                                                </div>
                                            </div>
                                            <div class="col-25">
                                                <div class="item-cell">
                                                    <div class="item-row">
                                                        &nbsp;
                                                    </div>
                                                    <div class="item-row" style="color: red;">
                                                        <a href="#" @click="editProduct('{{this.indexProduct}}')"
                                                            class="item-link tooltip-init"
                                                            data-tooltip="Edit Your Cart">
                                                            <i class="fas fa-fw fa-lg fa-edit text-color-red"></i></a>
                                                        <a href="#" @click="deleteProduct('{{this.indexProduct}}', '{{this.id}}')"
                                                            class="item-link tooltip-init"
                                                            data-tooltip="Remove from Cart">
                                                            <i class="fas fa-fw fa-lg fa-trash text-color-red"></i></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </li>
                        {{/each}}
                        {{/if}}
                    </ul>
                </div>
            </div>

            <div class="card">
                <div class="card-content card-content-padding">
                    <div class="list no-hairlines no-hairlines-between">
                        <ul>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Subtotal</div>
                                        <div class="item-after text-color-black">
                                            <input type="text" value="${{total.toFixed(2)}}" readonly="readonly"
                                                id="discount" style="width: 3.4rem;" />
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Reward points
                                            <div class="item-text">You have $0 redeem to use</div>
                                        </div>
                                        <div class="item-after">
                                            <label class="toggle toggle-init color-pink tooltip-init"
                                                data-tooltip="Redeem">
                                                <input type="checkbox" value="0" data-permission="redeem" />
                                                <span class="toggle-icon"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Discount</div>
                                        <div class="item-after">
                                            <input type="text" value="$0.00" readonly="readonly" id="discountValue"
                                                style="width: 3.4rem;" />
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">GST</div>
                                        <div class="item-after">
                                            <input type="text" value="$0.00" readonly="readonly" id="gstValue"
                                                style="width: 3.4rem;" />
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title"><b>Grand Total</b></div>
                                        <div class="item-after text-color-red"><input type="text"
                                                value="${{grandTotal.toFixed(2)}}" readonly="readonly" id="gst"
                                                style="width: 3.4rem;" /></div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="block">
                &nbsp;
            </div>
        </div>
        <div class="fab fab-right-top color-orange">
            <a href="/tab-order/" class="link item" @click="closeButton()">
                <i class="icon material-icons">close</i>
            </a>
        </div>
        <div class="fab fab-extended fab-center-bottom color-red" style="width: 120px;">
            <a href="#" class="link item" @click="checkout">
                <span style="font-family: cabin regular;">CHECKOUT</span>
            </a>
        </div>
        <!-- <div class="fab fab-morph fab-right-bottom color-orange">
            <a href="#" @click="clearProduct()">
                <span style="font-family: cabin regular;">Clear</span>
            </a>
        </div> -->
    </div>
</template>

<style scoped>
    .cart-name {
        font-size: 28px;
        font-weight: bold;
        letter-spacing: 0.5px;
        margin-top: 0px;
    }

    .detail-box {
        font-size: 18px;
        margin-top: 10px;
        background-color: lightgray;
        border: 1px;
        padding: 7px;
    }

    .your-cart {
        font-size: 28px;
        font-weight: bold;
        letter-spacing: 0.5px;
        margin-top: 0px;
        padding-left: 15px;
    }
</style>

<script>
    return {
        data: function () {
            return {
                quantity: 0,
                total: 0,
                productList: [
                ],
                listOrderDate: null,
                listOrderSession: null,
                orderSessionName: null,
                orderSessionTime: null,
                listOption: [],
                updateCartList: [],
                discount: 0,
                gst: 0,
                grandTotal: 0,
                redeem: 0,
                newOrder: {
                    collectionTime: '',
                    type: 3,
                    orderItems: [],
                    sessionId: ''
                }
            }
        },
        methods: {
            initializeTimepicker24: function () {
                var self = this;
                jQuery('#timepicker-24').timeDropper({
                    autoswitch: true,
                    format: 'HH:mm',
                    init_animation: 'dropDown',
                    meridians: false,
                    setCurrentTime: true
                });
            },
            deleteProduct: function (indexProduct, id) {
                var self = this;
                var tempGrandTotal = 0;
                var tempAvailableNumbers = 0;
                console.log(self.updateCartList);
                console.log(id);
                for (let i = 0; i < self.updateCartList.items.length; i++) {
                    if (self.updateCartList.items[i].indexProduct == indexProduct) {
                        self.updateCartList.quantity = self.updateCartList.quantity - self.updateCartList.items[i].orderQuantity;
                        self.updateCartList.total = self.updateCartList.total - self.updateCartList.items[i].price * self.updateCartList.items[i].orderQuantity;
                        tempGrandTotal = self.grandTotal - self.updateCartList.items[i].price * self.updateCartList.items[i].orderQuantity;
                        tempAvailableNumbers = self.updateCartList.items[i].orderQuantity;
                        console.log('tempAvailableNumbers',tempAvailableNumbers);
                        self.updateCartList.items.splice(i, 1);
                    }
                }
                if (self.updateCartList.items.length == 0) {
                    self.updateCartList.listOrderDate = null;
                    self.updateCartList.listOrderSession.name = null;
                    self.updateCartList.listOrderSession.startTime = '';
                    self.updateCartList.listOrderSession.endTime = '';
                    self.updateCartList.quantity = 0;
                    self.updateCartList.total = 0;
                    localStorage.removeItem('listOrderSession');
                    self.$setState({
                        listOrderDate: null,
                        orderSessionName: null,
                        orderSessionTime: null,
                    })
                }
                for (let i = 0; i < self.updateCartList.items.length; i++){
                    if (self.updateCartList.items[i].id == id){
                        self.updateCartList.items[i].availableNumbers += tempAvailableNumbers;
                        console.log('self.updateCartList.items[i].availableNumbers',self.updateCartList.items[i].availableNumbers);
                    }
                }
                console.log(self.updateCartList);
                localStorage.setItem('cartItems', JSON.stringify(self.updateCartList));
                let cartTemp = JSON.parse(localStorage.getItem('cartItems'));
                self.$setState({
                    updateCartList: cartTemp,
                    productList: cartTemp.items,
                    quantity: cartTemp.quantity,
                    total: cartTemp.total,
                    grandTotal: tempGrandTotal,
                })
            },
            clearProduct: function (indexProduct) {
                var self = this;
                console.log(self.updateCartList);
                self.updateCartList.items.splice(0, self.updateCartList.items.length);
                self.updateCartList.quantity = 0;
                self.updateCartList.total = 0;
                console.log(self.updateCartList);
                self.updateCartList.listOrderDate = null;
                self.updateCartList.listOrderSession.name = null;
                self.updateCartList.listOrderSession.startTime = '';
                self.updateCartList.listOrderSession.endTime = '';
                localStorage.setItem('cartItems', JSON.stringify(self.updateCartList));
                let cartTemp = JSON.parse(localStorage.getItem('cartItems'));
                self.$setState({
                    updateCartList: cartTemp,
                    productList: cartTemp.items,
                    quantity: cartTemp.quantity,
                    total: cartTemp.total,
                    listOrderDate: null,
                    orderSessionName: null,
                    orderSessionTime: null,
                })
            },
            editProduct: function (indexProduct) {
                var self = this;

                var isEdit = true;
                // //let orderDate = $('#date').val();
                // //let orderSession = self.$('select[name=session]').val();
                // //console.log(id);
                let det = self.productList.find(function (el) {
                    return el.indexProduct == indexProduct;
                })
                // for (let i = 0; i < self.productList.length; i++){
                //     if (self.productList[i].id == id && self.productList[i].indexProduct == i){
                //         det = self.productList[i];
                //     }
                // }
                console.log(det)
                det.editornew = true;
                localStorage.setItem('isEdit', isEdit);
                localStorage.setItem('editProduct', JSON.stringify(det));
                localStorage.setItem('cartItems', JSON.stringify(self.updateCartList));
                // // self.$setState({
                // // 	detail: det,
                // // 	tempQuantity: self.tempQuantity + 1,
                // // })
                // //console.log(self.detail)
                // // self.listOrderDate = orderDate;
                // // for (let i = 0; i < self.session.length; i++){
                // // 	if (orderSession == self.session[i].id){
                // // 		self.listOrderSession = self.session[i];
                // // 	}
                // // }
                // // localStorage.setItem('listOrderDate', JSON.stringify(self.listOrderDate));
                // // localStorage.setItem('listOrderSession', JSON.stringify(self.listOrderSession));
                app.views.current.router.navigate('/orders-options');
            },
            closeButton: function () {
                localStorage.removeItem('isEdit');
            },
            getDicount: function () {
                var self = this;
                let tempdiscount = $('#discountValue').val();
                let arr = tempdiscount.split('$');
                console.log('tempdiscount', tempdiscount)
                tempdiscount = arr[1];
                console.log('tempdiscount', tempdiscount)
                self.$setState({
                    discount: tempdiscount,
                });
            },
            getGST: function () {
                var self = this;
                let tempGST = $('#gstValue').val();
                let arr = tempGST.split('$');
                tempGST = arr[1];
                console.log('tempGST', tempGST)
                self.$setState({
                    gst: tempGST,
                });
            },
            checkout: function () {
                var self = this;
                let cartTemp = JSON.parse(localStorage.getItem('cartItems'));
                if (cartTemp != null) {
                    console.log(self.listOrderSession, self.listOrderDate)
                    console.log(cartTemp)
                    //let today = new Date();
                    // today.setTime(today.getTime() + (1000 * 60 * (self.listOrderSession.preparationTime + self.listOrderSession.bufferTime)))
                    // console.log(today)
                    // let dt = today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear();
                    // console.log(dt)
                    // if (dt == self.listOrderDate) {
                    //     console.log(today.toISOString())
                    //     self.newOrder.collectionTime = today.toISOString();
                    //     //self.newOrder.orderDate = today.toISOString();
                    // }
                    // else {
                    //     let arr = self.listOrderDate.split('/');
                    //     let time = self.listOrderSession.startTime.split(':');
                    //     console.log(arr)
                    //     let dat = new Date(arr[2], arr[1] - 1, arr[0], time[0], time[1])
                    //     dat.setTime(dat.getTime() + (1000 * 60 * (self.listOrderSession.preparationTime + self.listOrderSession.bufferTime)))
                    //     console.log(dat)
                    //     self.newOrder.collectionTime = dat.toISOString();
                    //     //self.newOrder.orderDate = dat.toISOString();
                    // }
                    let today = new Date();
                    var offset = -(today.getTimezoneOffset() / 60);
                    console.log(self.$('input[id=timepicker-24]').val())
                    let arr = self.listOrderDate.split('/');
                    let time = self.$('input[id=timepicker-24]').val().split(':');
                    let dat = new Date(arr[2], arr[1] - 1, arr[0], time[0], time[1]);
                    // var hours = dat.getHours();
                    // hours += offset;
                    // dat.setHours(hours);

                    self.newOrder.collectionTime = dat.toISOString();
                    //self.newOrder.type = 
                    self.newOrder.sessionId = self.listOrderSession.id;
                    self.newOrder.payments = [{
                        amount: self.grandTotal,
                        type: 1,
                        cardType: 1,
                        status: 1
                    }]
                    self.newOrder.orderItems = []
                    //add items
                    cartTemp.items.forEach(function (el) {
                        let temp = {
                            productId: el.id,
                            productName: el.name,
                            quantity: el.orderQuantity,
                            price: el.price,
                            modifiers: []
                        };

                        for (let i = 0; i < el.modifierGroups.length; i++) {
                            for (let j = 0; j < el.modifierGroups[i].modifiers.length; j++) {
                                if (el.modifierGroups[i].modifiers[j].isChoose == true) {
                                    let mod = {
                                        modifierId: el.modifierGroups[i].modifiers[j].id,
                                        modifierName: el.modifierGroups[i].modifiers[j].name,
                                        quantity: 1
                                    }
                                    temp.modifiers.push(mod)
                                }
                            }
                        }
                        self.newOrder.orderItems.push(temp)
                    })
                    console.log('newOrder', self.newOrder)
                    //app.views.current.router.navigate('/orders-finish'); 
                    //create new order
                    app.request.postJSON(window.config.url + 'api/services/app/Preorder/CreateOrder',
                        {
                            collectionTime: self.newOrder.collectionTime,
                            type: self.newOrder.type,
                            orderItems: self.newOrder.orderItems,
                            payments: self.newOrder.payments,
                            sessionId: self.newOrder.sessionId
                        },
                        function (suc) {
                            console.log('suc', suc)
                            localStorage.removeItem('cartItems')
                            app.views.current.router.navigate('/orders-finish?order=' + suc.result.orderNumber);  
                        },
                        function (err) {
                            console.log('err', err)
                        })
                }
            },
            showTimePicker: function(){
                var today = new Date();
                let sessionTemp = JSON.parse(localStorage.getItem('listOrderSession'))
                today.setTime(today.getTime() + (sessionTemp.preparationTime * 60 * 1000) + (sessionTemp.bufferTime * 60 * 1000));
                today = new Date(today);
                var pickerInline = app.picker.create({
                //containerEl: '#demo-picker-date-container',
                inputEl: '#timepicker-24',
                toolbar: false,
                rotateEffect: true,
                value: [
                    today.getHours(),
                    today.getMinutes() < 10 ? '0' + today.getMinutes() : today.getMinutes()
                ],
                formatValue: function (values) {
                    return values[0] + ':' + values[1];
                },
                cols: [
                    // Hours
                    {
                    values: (function () {
                        var arr = [];
                        for (var i = 0; i <= 23; i++) { arr.push(i); }
                        return arr;
                    })(),
                    },
                    // Divider
                    {
                    divider: true,
                    content: ':'
                    },
                    // Minutes
                    {
                    values: (function () {
                        var arr = [];
                        for (var i = 0; i <= 59; i++) { arr.push(i < 10 ? '0' + i : i); }
                        return arr;
                    })(),
                    }
                ],
                on: {
                    change: function (picker, values) {
                    
                    },
                }
                });
            }
        },
        on: {
            pageInit: function () {
                var self = this;
                //self.initializeTimepicker24()
                let cartTemp = JSON.parse(localStorage.getItem('cartItems'));
                console.log('cartTemp:', cartTemp);
                let tempString = [];
                if (cartTemp != null)
                    for (let i = 0; i < cartTemp.items.length; i++) {
                        cartTemp.items[i].editornew = false;
                        cartTemp.items[i].indexProduct = i + '-' + cartTemp.items[i].id;
                    }
                self.getDicount();
                self.getGST();
                self.$('input[type=checkbox]').change(function () {
                    let tempRedeem = $(this).val();
                    if ($(this).is(":checked")) {
                        self.$setState({
                            grandTotal: cartTemp.total - Number(tempRedeem) - Number(self.discount) + Number(self.gst),
                        })
                    }
                    else {
                        self.$setState({
                            grandTotal: cartTemp.total - 0 - Number(self.discount) + Number(self.gst),
                        })
                    }
                })
                self.$('input[type=radio]').change(function (){
                    console.log($(this).val())
                    self.newOrder.type = $(this).val();
                });
                if (cartTemp != null) {
                    self.$setState({
                        updateCartList: cartTemp,
                        productList: cartTemp.items,
                        quantity: cartTemp.quantity,
                        total: cartTemp.total,
                        listOrderDate: cartTemp.listOrderDate,
                        listOrderSession: cartTemp.listOrderSession,
                        orderSessionName: cartTemp.listOrderSession.name,
                        orderSessionTime: cartTemp.listOrderSession.startTime + " - " + cartTemp.listOrderSession.endTime,
                        grandTotal: cartTemp.total - Number(self.discount) + Number(self.gst),
                    })
                }
                console.log('productList', self.productList)
                self.showTimePicker();    
            }
        }
    }
</script>