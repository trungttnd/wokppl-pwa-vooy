<template>
    <div class="page">
        <div class="navbar" style="height: 72px;">
            <div class="navbar-inner">
                <img class="theme-light-only" src="{{uploadUrl}}{{logo}}" height="60px" alt="" />
                <div class="right">

                </div>
            </div>
        </div>

        <div class="page-content" style="padding-top: 44px;">
            <div class="block text-align-left"></div>
            <div class="content-block block-card text-align-left">
                <div class="your-cart">Order Details:</div>
            </div>
            <div class="card">
                <div class="card-content card-content-padding">
                    <div class="list no-hairlines no-hairlines-between">
                        <ul>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Order Date: {{listOrderDate}}</div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Session: {{orderSessionName}}</div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-media">Collection Time:<i
                                            class="icon material-icons text-color-red"
                                            style="margin-left: 13px;">access_time</i>&nbsp;</div>

                                    <div class="item-inner" style="margin-left: 0px; width: 120px; padding: unset;">
                                        <div class="item-input">
                                            <input type="text" placeholder="Select" readonly="readonly"
                                                id="timepicker-24" />
                                        </div>
                                    </div>
                                    <div style="width: -webkit-fill-available; margin-top: -30px;margin-left: -30px;">
                                        <a class="link dynamic-popover" href="#" style="color: black"></a>
                                    </div>

                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Receive Method: &nbsp;
                                            <label class="radio">
                                                <input type="radio" name="radio" value="3" checked />
                                                <i class="icon-radio"></i>
                                            </label>
                                            &nbsp;Dine In&nbsp;&nbsp;
                                            <label class="radio color-red">
                                                <input type="radio" name="radio" value="2" />
                                                <i class="icon-radio"></i>
                                            </label>
                                            &nbsp;Take Away
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- <div class="block text-align-left"></div> -->
            <div class="content-block block-card text-align-left">
                <div class="your-cart">Your Cart:</div>
            </div>
            <div class="card">
                <div class="list media-list no-hairlines no-hairlines-between margin-vertical descriptionFont">
                    <ul>
                        {{#if productList}}
                        {{#each productList}}
                        <li>
                            <div class="item-content">
                                {{#if this.isNoImage}}
                                <div class="item-media"><img src="assets/custom/img/{{this.imageFileName}}"
                                        width="80" />
                                </div>
                                {{else}}
                                <div class="item-media"><img src="{{this.imageFileNameDisplay}}" width="80" />
                                </div>
                                {{/if}}
                                <div class="item-inner">
                                    <div class="item-title-row">
                                        <div class="item-title" style="max-width: 70%;">{{this.name}}</div>
                                        <div class="item-title">
                                            ${{this.price.toFixed(2)}} x {{this.orderQuantity}}
                                        </div>

                                    </div>
                                    <div class="item-text">
                                        <div class="row">
                                            <div class="col-75">
                                                <div class="item-cell">
                                                    {{#each this.modifierGroups}}
                                                    <div class="item-row">
                                                        {{this.name}}: {{#each this.modifiers}} {{#if this.isChoose}}
                                                        {{this.name}} {{/if}} {{/each}}
                                                    </div>
                                                    {{/each}}
                                                </div>
                                            </div>
                                            <div class="col-25">
                                                <div class="item-cell">
                                                    <div class="item-row">
                                                        &nbsp;
                                                    </div>
                                                    <div class="item-row" style="color: red;">
                                                        <a href="#" @click="editProduct('{{this.indexProduct}}')"
                                                            class="item-link tooltip-init"
                                                            data-tooltip="Edit Your Cart">
                                                            <i class="fas fa-fw fa-lg fa-edit text-color-red"></i></a>
                                                        <a href="#"
                                                            @click="deleteProduct('{{this.indexProduct}}', '{{this.id}}')"
                                                            class="item-link tooltip-init"
                                                            data-tooltip="Remove from Cart">
                                                            <i class="fas fa-fw fa-lg fa-trash text-color-red"></i></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </li>
                        {{/each}}
                        {{/if}}
                    </ul>
                </div>
            </div>

            <div class="card">
                <div class="card-content card-content-padding">
                    <div class="list no-hairlines no-hairlines-between">
                        <ul>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Subtotal</div>
                                        <div class="item-after text-color-black">
                                            <input type="text" value="${{total.toFixed(2)}}" readonly="readonly"
                                                id="discount" style="width: 3.4rem;" />
                                        </div>
                                    </div>
                                </div>
                            </li>
                            {{#if isEnabledPoint}}
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Reward points
                                            <div class="item-text">You have ${{redeem.toFixed(2)}} redeem to use</div>
                                        </div>
                                        <div class="item-after">
                                            <label class="toggle toggle-init color-pink tooltip-init"
                                                data-tooltip="Redeem">
                                                <input type="checkbox" />
                                                <span class="toggle-icon"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            {{/if}}
                            <!-- <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">Discount</div>
                                        <div class="item-after">
                                            <input type="text" value="${{discount}}" readonly="readonly"
                                                id="discountValue" style="width: 3.4rem;" />
                                        </div>
                                    </div>
                                </div>
                            </li> -->
                            {{#js_if "this.gst>0"}}
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title">GST Amount</div>
                                        <div class="item-after">
                                            <input type="text" value="${{gstAmount.toFixed(2)}}" readonly="readonly"
                                                id="gstValue" style="width: 3.4rem;" />
                                        </div>
                                    </div>
                                </div>
                            </li>
                            {{/js_if}}
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title"><b>Grand Total</b></div>
                                        <div class="item-after text-color-red"><input type="text"
                                                value="${{grandTotal.toFixed(2)}}" readonly="readonly" id="gst"
                                                style="width: 3.4rem;" /></div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="content-block block-card text-align-left">
                <div class="your-cart">Payment methods</div>
            </div>
            <div class="card">
                <div class="card-content card-content-padding">
                    <div class="list no-hairlines no-hairlines-between">
                        <ul>
                            {{#if listCard}}
                            {{#each listCard}}
                            <li>
                                <div class="item-content">
                                    <div class="item-media">
                                        <i class="fa-stack">
                                            <span
                                                class="fas fa-square fa-stack-2x brand-color-dribbble ios-only"></span>
                                            <span class="fas fa-circle fa-stack-2x brand-color-dribbble md-only"></span>
                                            <span class="fa fa-university fa-stack-1x fa-inverse"></span>
                                        </i>
                                    </div>
                                    <div class="item-inner">
                                        <!-- <div class="item-title-row">
                                                <div class="item-title">{{this.cardHolderName}}</div>
                                            </div> -->
                                        <div class="item-text">{{this.cardNumber}}</div>
                                        </a>
                                        <div class="item-after">
                                            <label class="toggle toggle-init" id="toggle1"
                                                @click="clickHandle({{this.id}}, {{this.isDefault}})">
                                                {{#if this.isDefault}}
                                                <input type="checkbox" checked disabled />
                                                {{else}}
                                                <input type="checkbox" />
                                                {{/if}}
                                                <span class="toggle-icon"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            {{/each}}
                            {{/if}}
                            <li>
                                <a href="/payment-method-new" class="item-link">
                                    <div class="item-content">
                                        <div class="item-media">
                                            <i class="fa-stack">
                                                <span class="fas fa-circle fa-stack-2x brand-color-google"></span>
                                                <span class="fa fa-plus fa-stack-1x fa-inverse"></span>
                                            </i>
                                        </div>
                                        <div class="item-inner">
                                            <div class="item-title">Add new credit card</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="block">
                &nbsp;
            </div>
        </div>
        <div class="gpopover" id="my-popover">
            <div class="popover-inner">
                <div class="block">
                    <p>Choose the time you want to receive the goods.</p>
                </div>
            </div>
        </div>
        {{#if disableCloseButton}}
        <div class="fab fab-right-top color-orange" style="padding-top: 20px;">
            <a class="link item">
                <i class="icon material-icons">close</i>
            </a>
        </div>
        {{else}}
        <div class="fab fab-right-top color-orange" style="padding-top: 20px;">
            <a href="#" @click="closeButton()">
                <i class="icon material-icons">close</i>
            </a>
        </div>
        {{/if}}
        <!-- {{#if disableCheckout}} -->
        <div class="fab fab-extended fab-center-bottom color-red" style="width: 120px;">
            <a href="#" class="link item" @click="validate">
                <span style="font-family: cabin regular;">CHECKOUT</span>
            </a>
        </div>
        <!-- {{/if}} -->
        <!-- <div class="fab fab-morph fab-right-bottom color-orange">
            <a href="#" @click="clearProduct()">
                <span style="font-family: cabin regular;">Clear</span>
            </a>
        </div> -->
    </div>
</template>

<style scoped>
    .cart-name {
        font-size: 28px;
        font-weight: bold;
        letter-spacing: 0.5px;
        margin-top: 0px;
    }

    .detail-box {
        font-size: 18px;
        margin-top: 10px;
        background-color: lightgray;
        border: 1px;
        padding: 7px;
    }

    .your-cart {
        font-size: 28px;
        font-weight: bold;
        letter-spacing: 0.5px;
        margin-top: 0px;
        padding-left: 15px;
    }
</style>

<script>
    return {
        data: function () {
            return {
                quantity: 0,
                total: 0,
                productList: [],
                listOrderDate: null,
                listOrderSession: null,
                orderSessionName: null,
                orderSessionTime: null,
                listOption: [],
                updateCartList: [],
                discount: 0,
                gst: +localStorage.getItem('WOKPPL_gst'),
                gstAmount: 0,
                gstType: localStorage.getItem('WOKPLL_gstType'), //type: inclusive (0)/exclusive (1)
                grandTotal: 0,
                redeem: 0,
                checkToggle: false,
                newOrder: {
                    collectionTime: '',
                    type: 3,
                    orderItems: [],
                    sessionId: ''
                },
                disableCheckout: true,
                disableCloseButton: false,
                messageTime: '',
                validateOk: true,
                hourStart: 0,
                hourEnd: 23,
                minuteStart: 0,
                minuteEnd: 59,
                isEnabledPoint: true,
                ratePoint: {
                    earnPointRate: 0.0,
                    redeemPointRate: 0.0
                },
                defaultPickerDate: new Date(),
                isFutureOrder: false,
                uploadUrl: window.config.upload,
                logo: localStorage.getItem('WOKPPL_logoUrl'),
                listCard: null,
                paymentMethodId: 0,
                busyBtn: true
            }
        },
        methods: {
            getStatusRewardOint: function () {
                var self = this;
                //get status Reward Point: IsEnabled (true/false)
                //API GetLoyaltyPointRateInfo
                app.request.get(window.config.url + 'api/services/app/Preorder/GetLoyaltyPointRateInfo',
                    function (suc) {
                        let response = JSON.parse(suc)
                        //console.log(response.result)
                        self.$setState({
                            ratePoint: response.result
                        });
                        //API GetCurrentLoyaltyPointInfo
                        setTimeout(function () {
                            app.request.get(window.config.url +
                                'api/services/app/Preorder/GetCurrentLoyaltyPointInfo',
                                function (suc) {
                                    let res = JSON.parse(suc)
                                    //console.log(res.result)
                                    self.$setState({
                                        isEnabledPoint: res.result.enabled,
                                        redeem: res.result.point * response.result.redeemPointRate
                                    })
                                },
                                function (err) {
                                    console.log(err)
                                });
                        })
                    },
                    function (err) {
                        console.log(err)
                    });


            },
            initializeTimepicker24: function () {
                var self = this;
                jQuery('#timepicker-24').timeDropper({
                    autoswitch: true,
                    format: 'HH:mm',
                    init_animation: 'dropDown',
                    meridians: false,
                    setCurrentTime: true
                });
            },
            deleteProduct: function (indexProduct, id) {
                var self = this;
                var tempGrandTotal = 0;
                var tempAvailableNumbers = 0;
                //console.log(self.updateCartList);
                //console.log(id);
                for (let i = 0; i < self.updateCartList.items.length; i++) {
                    if (self.updateCartList.items[i].indexProduct == indexProduct) {
                        self.updateCartList.quantity = self.updateCartList.quantity - self.updateCartList.items[i]
                            .orderQuantity;
                        self.updateCartList.total = self.updateCartList.total - self.updateCartList.items[i].price *
                            self.updateCartList.items[i].orderQuantity;
                        tempGrandTotal = self.grandTotal - self.updateCartList.items[i].price * self.updateCartList
                            .items[i].orderQuantity;
                        tempAvailableNumbers = self.updateCartList.items[i].orderQuantity;
                        //console.log('tempAvailableNumbers', tempAvailableNumbers);
                        self.updateCartList.items.splice(i, 1);
                    }
                }
                if (self.updateCartList.items.length == 0) {
                    self.updateCartList.listOrderDate = null;
                    self.updateCartList.listOrderSession.name = null;
                    self.updateCartList.listOrderSession.startTime = '';
                    self.updateCartList.listOrderSession.endTime = '';
                    self.updateCartList.quantity = 0;
                    self.updateCartList.total = 0;
                    // Cho nay dat remove luon 2 cai session ngay va gio
                    // Nhu the moi dam bao cho viec xoa cai product cuoi cung cung la tuong duong voi clear cart
                    // Neu nhin o ben tab order ma van con luu ngay cua lan add cart cuoi cung thi van dang sai
                    // Comment nay chi mang tinh chat luu note chu khong de lam gi ca
                    localStorage.removeItem('listOrderSession');
                    localStorage.removeItem('listOrderDate');
                    localStorage.removeItem('disableCheckout');
                    localStorage.removeItem('cartItems');
                    self.$setState({
                        listOrderDate: null,
                        orderSessionName: null,
                        orderSessionTime: null,
                    });
                    app.views.current.router.navigate('/tab-order/');
                }
                for (let i = 0; i < self.updateCartList.items.length; i++) {
                    if (self.updateCartList.items[i].id == id) {
                        self.updateCartList.items[i].availableNumbers += tempAvailableNumbers;
                        // console.log('self.updateCartList.items[i].availableNumbers', self.updateCartList.items[i]
                        //     .availableNumbers);
                    }
                }
                //console.log(self.updateCartList);
                localStorage.setItem('cartItems', JSON.stringify(self.updateCartList));
                let cartTemp = JSON.parse(localStorage.getItem('cartItems'));
                self.$setState({
                    updateCartList: cartTemp,
                    productList: cartTemp.items,
                    quantity: cartTemp.quantity,
                    total: cartTemp.total,
                    grandTotal: tempGrandTotal,
                })
            },
            clearProduct: function (indexProduct) {
                var self = this;
                //console.log(self.updateCartList);
                self.updateCartList.items.splice(0, self.updateCartList.items.length);
                self.updateCartList.quantity = 0;
                self.updateCartList.total = 0;
                //console.log(self.updateCartList);
                self.updateCartList.listOrderDate = null;
                self.updateCartList.listOrderSession.name = null;
                self.updateCartList.listOrderSession.startTime = '';
                self.updateCartList.listOrderSession.endTime = '';
                localStorage.setItem('cartItems', JSON.stringify(self.updateCartList));
                let cartTemp = JSON.parse(localStorage.getItem('cartItems'));
                self.$setState({
                    updateCartList: cartTemp,
                    productList: cartTemp.items,
                    quantity: cartTemp.quantity,
                    total: cartTemp.total,
                    listOrderDate: null,
                    orderSessionName: null,
                    orderSessionTime: null,
                })
            },
            editProduct: function (indexProduct) {
                var self = this;

                var isEdit = true;
                // //let orderDate = $('#date').val();
                // //let orderSession = self.$('select[name=session]').val();
                // //console.log(id);
                let det = self.productList.find(function (el) {
                    return el.indexProduct == indexProduct;
                })
                // for (let i = 0; i < self.productList.length; i++){
                //     if (self.productList[i].id == id && self.productList[i].indexProduct == i){
                //         det = self.productList[i];
                //     }
                // }
                //console.log(det)
                det.editornew = true;
                localStorage.setItem('isEdit', isEdit);
                localStorage.setItem('editProduct', JSON.stringify(det));
                localStorage.setItem('cartItems', JSON.stringify(self.updateCartList));

                app.views.current.router.navigate('/orders-options');
            },
            closeButton: function () {
                localStorage.removeItem('isEdit');
                app.views.current.router.navigate('/tab-order/');
            },
            compareDate: function (date1, date2) {
                var self = this;
                let a = date1.toISOString().substr(0, 16);
                let b = date2.toISOString().substr(0, 16);
                if (a > b) return true
                else return false
            },
            validate: function () {
                var self = this;
                if (self.busyBtn) {
                    self.busyBtn = false;
                    //console.log("true");
                    self.validateOk = true;
                    //console.log(self.$('input[id=timepicker-24]').val())
                    let arrTime = self.$('input[id=timepicker-24]').val().split(':')
                    self.checkCollectionTime(arrTime)
                    if (self.validateOk == true)
                        self.checkout();
                }
                else console.log("disable checkout")
                //console.log(self.paymentMethodId)
            },
            checkout: function () {
                var self = this;
                let cartTemp = JSON.parse(localStorage.getItem('cartItems'));
                let sessionTemp = JSON.parse(localStorage.getItem('listOrderSession'));

                if (cartTemp != null) {
                    //console.log(self.listOrderSession, self.listOrderDate)
                    //console.log(cartTemp)

                    let today = new Date();
                    var offset = -(today.getTimezoneOffset() / 60);

                    let arr = self.listOrderDate.split('/');
                    let time = self.$('input[id=timepicker-24]').val().split(':');
                    let dat = new Date(arr[2], arr[1] - 1, arr[0], time[0], time[1]);
                    // var hours = dat.getHours();
                    // hours += offset;
                    // dat.setHours(hours);
                    let startTime = new Date(arr[2], arr[1] - 1, arr[0], sessionTemp.startTime.split(':')[0],
                        sessionTemp.startTime.split(':')[1])
                    let endTime = new Date(arr[2], arr[1] - 1, arr[0], sessionTemp.endTime.split(':')[0],
                        sessionTemp.endTime.split(':')[1])
                    self.newOrder.collectionTime = dat.toISOString();
                    //self.newOrder.type = 
                    self.newOrder.sessionId = self.listOrderSession.id;
                    self.newOrder.payments = [{
                        amount: self.grandTotal,
                        type: 1,
                        cardType: 1,
                        status: 1
                    }]
                    self.newOrder.orderItems = []
                    //add items
                    cartTemp.items.forEach(function (el) {
                        let temp = {
                            productId: el.id,
                            productName: el.name,
                            quantity: el.orderQuantity,
                            price: el.price,
                            modifiers: []
                        };

                        for (let i = 0; i < el.modifierGroups.length; i++) {
                            for (let j = 0; j < el.modifierGroups[i].modifiers.length; j++) {
                                if (el.modifierGroups[i].modifiers[j].isChoose == true) {
                                    let mod = {
                                        modifierId: el.modifierGroups[i].modifiers[j].id,
                                        modifierName: el.modifierGroups[i].modifiers[j].name,
                                        quantity: 1
                                    }
                                    temp.modifiers.push(mod)
                                }
                            }
                        }
                        self.newOrder.orderItems.push(temp)
                    })
                    console.log('newOrder', self.newOrder)
                    //app.views.current.router.navigate('/orders-finish'); 
                    //create new order
                    app.request.postJSON(window.config.url + 'api/services/app/Preorder/Checkout', {
                        payWithPointEnabled: self.checkToggle,
                        //totalAmount: self.grandTotal,
                        collectionTime: self.newOrder.collectionTime,
                        type: self.newOrder.type,
                        orderItems: self.newOrder.orderItems,
                        //payments: self.newOrder.payments,
                        sessionId: self.newOrder.sessionId,
                        startTime: startTime.toISOString(),
                        endTime: endTime.toISOString(),
                        paymentMethodId: self.paymentMethodId
                    },
                        function (suc) {
                            //console.log('suc', suc)
                            localStorage.removeItem('cartItems');
                            localStorage.removeItem('listOrderSession');
                            localStorage.removeItem('listOrderDate');
                            app.views.current.router.navigate('/orders-finish?order=' + suc.result.orderNumber);
                            self.busyBtn = true;
                        },
                        function (err) {
                            console.log('err', err)
                            let response = JSON.parse(err.response)
                            self.disableCloseButton = false;
                            var dialog = app.dialog.create({
                                content: '<div class="block no-margin margin-top text-align-center"><i class="fa-stack fa-3x"><span class="fas fa-stack-2x fa-circle text-color-red"></span><span class="fas fa-stack-1x fa-inverse fa-times"></span></i><p>' +
                                    response.error.message + '.</p></div>',
                                buttons: [{
                                    text: 'Cancel',
                                    bold: true,
                                    color: 'red',
                                    onClick: function () {
                                        self.$setState({
                                            disableCloseButton: false,
                                        })
                                    }
                                }]
                            });
                            dialog.open();
                            self.busyBtn = true;
                        })
                }
            },
            showTimePicker: function () {
                var self = this;
                var today = new Date();
                let minStart = 0;
                let minEnd = 59;
                let sessionTemp = JSON.parse(localStorage.getItem('listOrderSession'));
                let orderDateTemp = JSON.parse(localStorage.getItem('listOrderDate'));
                console.log('listOrderSession', sessionTemp);
                console.log('listOrderDate', orderDateTemp)
                console.log('todayDate', moment(today).format('DD/MM/YYYY'))

                let hourDefault = '00';
                let minuteDefault = '00';
                let startTimeDisplay = new Date(sessionTemp.startTimeDisplay);

                if (today < startTimeDisplay) {
                    let orderTime = startTimeDisplay.setTime(startTimeDisplay.getTime() + (sessionTemp.preparationTime * 60 * 1000) + (sessionTemp.bufferTime * 60 * 1000));
                    let orderDatetime = new Date(orderTime);

                    hourDefault = moment(orderDatetime).format('hh');
                    minuteDefault = moment(orderDatetime).format('mm');
                }
                else {
                    console.log('hien tai > start Time')
                    let todayEx = today.setTime(today.getTime() + (sessionTemp.preparationTime * 60 * 1000) + (sessionTemp.bufferTime * 60 * 1000) + 60 * 1000);
                    todayEx = new Date(todayEx);
                    hourDefault = moment(todayEx).format('hh');
                    minuteDefault = moment(todayEx).format('mm');
                }

                // Doan nay compare ngay hien tai va ngay tuong lai
                // Hoi loang ngoang
                // let orderDateTempNew = orderDateTemp.split('/');
                // orderDateTempNew = orderDateTempNew[1] + '/' + orderDateTempNew[0] + '/' + orderDateTempNew[2];
                // let orderDateTempDefault = orderDateTempNew
                // orderDateTempNew = new Date(orderDateTempNew);
                // let todayNew = new Date();
                // let todayWithDayOnly = new Date((todayNew.getMonth() + 1) + '/' + todayNew.getDate() + '/' +
                //     todayNew.getFullYear());
                // let orderDateTempWithDayOnly = new Date((orderDateTempNew.getMonth() + 1) + '/' + orderDateTempNew
                //     .getDate() + '/' + orderDateTempNew.getFullYear());
                // if (orderDateTempWithDayOnly > todayWithDayOnly) {
                //     let dateTimeDefault = orderDateTempDefault + ' ' + sessionTemp.startTime;
                //     dateTimeDefault = new Date(dateTimeDefault);
                //     today = dateTimeDefault;
                // }
                // // Het doan compare
                // today.setTime(today.getTime() + (sessionTemp.preparationTime * 60 * 1000) + (sessionTemp
                //     .bufferTime * 60 * 1000));
                // today = new Date(today);
                //console.log('today.getHours()', today.getHours());
                //console.log('+self.hourStart', +self.hourStart);
                var pickerInline = app.picker.create({
                    //containerEl: '#demo-picker-date-container',
                    inputEl: '#timepicker-24',
                    toolbar: false,
                    rotateEffect: true,
                    url: "/orders-cart",
                    value: [
                        // (today.getHours() >= +self.hourStart && today.getHours() <= +self.hourEnd) ? (today.getHours() < 10 ? '0' + today.getHours() : today.getHours()) : self
                        //     .hourStart,
                        // today.getMinutes() < 10 ? '0' + today.getMinutes() : today.getMinutes()
                        hourDefault, minuteDefault
                    ],
                    formatValue: function (values) {
                        return values[0] + ':' + values[1];
                    },
                    cols: [
                        // Hours
                        {
                            values: (function () {
                                var arr = [];
                                for (var i = +self.hourStart; i <= +self.hourEnd; i++) {
                                    i < 10 ? arr.push('0' + i) : arr.push(i);
                                }
                                return arr;
                            })(),
                        },
                        // Divider
                        {
                            divider: true,
                            content: ':'
                        },
                        // Minutes
                        {
                            values: (function () {
                                var arr = [];
                                for (var i = minStart; i <= minEnd; i++) {
                                    arr.push(i < 10 ? '0' + i : i);
                                }
                                return arr;
                            })(),
                        }
                    ],
                    on: {
                        change: function (picker, values) {
                            // console.log('values', values);
                            // if (values[0]==self.hourEnd) minEnd = self.minuteEnd;
                            // if (values[0]==self.hourStart) minStart = self.minStart;
                        },
                        close: function (picker) {
                            //console.log('picker', picker);
                            self.checkCollectionTime(picker.value);
                            self.$setState({
                                disableCloseButton: false,
                            })
                        }
                    }
                });
            },
            openDialog: function (message) {
                var self = this;
                var dialog = app.dialog.create({
                    title: '',
                    content: '<div class="block no-margin no-padding text-align-center" style="font-size: 14px;"><img src="' +
                        window.config.app.logo + '" width="84" alt="" /><p>' + message + '</p></div>',
                    verticalButtons: true,
                    buttons: [{
                        text: 'Ok',
                        bold: true,
                        color: 'green',
                        onClick: function () {
                            self.$('input[id=timepicker-24]').val(self.setTimeNow());
                            self.$setState({
                                disableCloseButton: false,
                            })
                        }
                    },]
                });
                return dialog;
            },
            setTimeNow: function () {
                var self = this;
                let nowDateTime = new Date();
                let sessionTemp = JSON.parse(localStorage.getItem('listOrderSession'));
                nowDateTime.setTime(nowDateTime.getTime() + (sessionTemp.preparationTime * 60 * 1000) + (sessionTemp
                    .bufferTime * 60 * 1000));
                nowDateTime = new Date(nowDateTime);
                var nowHours = nowDateTime.getHours() < 10 ? '0' + nowDateTime.getHours() : nowDateTime.getHours();
                var nowMinutes = nowDateTime.getMinutes() < 10 ? '0' + nowDateTime.getMinutes() : nowDateTime
                    .getMinutes();
                var timeNow = nowHours + ':' + nowMinutes;
                return timeNow;
            },
            checkCollectionTime: function (values) {
                var self = this;

                if (values == null) {
                    var timePicker = self.$('input[id=timepicker-24]').val();
                } else {
                    var timePicker = values[0] + ':' + values[1];
                }
                let startDateTimeExtend = new Date();
                let dateTimeNow = new Date();
                let dateTimeNowExtend = new Date();
                let dateTimeNowPlus = new Date();
                let dayNow = (dateTimeNow.getMonth() + 1) + '/' + dateTimeNow.getDate() + '/' + dateTimeNow
                    .getFullYear();
                let acceptPicker = 0;
                let sessionTemp = JSON.parse(localStorage.getItem('listOrderSession'));
                let orderDateTemp = JSON.parse(localStorage.getItem('listOrderDate'));

                // Ngay lay tu session
                let arrDate = orderDateTemp.split('/');
                let sessionDate = arrDate[1] + '/' + arrDate[0] + '/' + arrDate[2];
                // Gan ngay lay tu session voi startime
                let startDateTime = sessionDate + ' ' + sessionTemp.startTime;
                startDateTime = new Date(startDateTime);
                //console.log('Chan lai startDateTime', startDateTime, startDateTime.getHours());
                //console.log('sessionTemp', sessionTemp);
                startDateTimeExtend.setTime(startDateTime.getTime() + (sessionTemp.preparationTime * 60 * 1000) + (
                    sessionTemp.bufferTime * 60 * 1000));
                startDateTimeExtend = new Date(startDateTimeExtend);
                //console.log('Chan lai startDateTimeExtend', startDateTimeExtend);
                // Gan ngay lay tu session voi endtime
                let endDateTime = sessionDate + ' ' + sessionTemp.endTime;
                endDateTime = new Date(endDateTime);
                // Gan ngay lay tu session voi timepicker
                let pickerDateTime = sessionDate + ' ' + timePicker;
                pickerDateTime = new Date(pickerDateTime);
                // Gan ngay hien tai voi timepicker
                let tempDateTimeNow = dayNow + ' ' + timePicker;
                tempDateTimeNow = new Date(tempDateTimeNow);
                dateTimeNowPlus.setTime(dateTimeNow.getTime() + (sessionTemp.preparationTime * 60 * 1000) + (
                    sessionTemp.bufferTime * 60 * 1000));
                dateTimeNowExtend.setTime(tempDateTimeNow.getTime());
                dateTimeNowExtend = new Date(dateTimeNowExtend);

                // console.log(startDateTimeExtend, dateTimeNowPlus, self.compareDate(startDateTimeExtend,
                //     dateTimeNowPlus))
                // if (startDateTimeExtend > dateTimeNowPlus) 
                if (self.compareDate(startDateTimeExtend, dateTimeNowPlus)) {
                    self.messageTime = startDateTimeExtend.getHours() + ':' + (startDateTimeExtend.getMinutes() <
                        10 ? '0' + startDateTimeExtend.getMinutes() : startDateTimeExtend.getMinutes());
                } else {
                    self.messageTime = dateTimeNowPlus.getHours() + ':' + (dateTimeNowPlus.getMinutes() < 10 ? '0' +
                        dateTimeNowPlus.getMinutes() : dateTimeNowPlus.getMinutes());
                }

                // let message = "Collection time is invalid. Collection time should be range from " + self.messageTime + " to " + endDateTime.getHours() + ':' + (endDateTime.getMinutes() < 10 ? '0' + endDateTime.getMinutes() : endDateTime.getMinutes()) + "!";
                // if (self.compareDate(pickerDateTime, endDateTime)) {

                //     // if (pickerDateTime > dateTimeNowPlus)
                //     // if (self.compareDate(dateTimeNowPlus, pickerDateTime))
                //     message = "The time it takes for us to prepare your order at this session is not enough. Please select another session."
                //     self.openDialog(message).open();
                //     self.validateOk = false;
                // }
                // else {
                //     acceptPicker = acceptPicker + 1;
                // }
                // if (self.compareDate(startDateTimeExtend, pickerDateTime) || self.compareDate(dateTimeNowPlus, pickerDateTime)) {
                //     //let message = "Collection time is not smaller " + self.messageTime + "!";
                //     self.openDialog(message).open();
                //     self.validateOk = false;
                // } 
                // else if (self.compareDate(pickerDateTime, dateTimeNow) && self.compareDate(endDateTime, pickerDateTime) && self.compareDate(dateTimeNowPlus, endDateTime)) {
                //     message = "The time it takes for us to prepare your order at this session is not enough. Please select another session."
                //     self.openDialog(message).open();
                //     self.validateOk = false;
                // }
                // else {
                //     acceptPicker = acceptPicker + 1;
                // }
                if (self.compareDate(startDateTimeExtend, pickerDateTime)) {
                    let message = "Collection time is invalid. Collection time should be range from " + self
                        .messageTime + " to " + endDateTime.getHours() + ':' + (endDateTime.getMinutes() < 10 ?
                            '0' + endDateTime.getMinutes() : endDateTime.getMinutes()) + "!";
                    self.openDialog(message).open();
                    self.validateOk = false;
                } else if (self.compareDate(pickerDateTime, endDateTime) && self.compareDate(startDateTime,
                    dateTimeNowPlus)) {
                    let message = "Collection time is invalid. Collection time should be range from " + self
                        .messageTime + " to " + endDateTime.getHours() + ':' + (endDateTime.getMinutes() < 10 ?
                            '0' + endDateTime.getMinutes() : endDateTime.getMinutes()) + "!";
                    self.openDialog(message).open();
                    self.validateOk = false;
                } else if (self.compareDate(dateTimeNowPlus, endDateTime)) {
                    message =
                        "The time it takes for us to prepare your order at this session is not enough. Please select another session."
                    self.openDialog(message).open();
                    self.validateOk = false;
                } else if (self.compareDate(dateTimeNowPlus, pickerDateTime)) {
                    let message = "Collection time is invalid. Collection time should be range from " + self
                        .messageTime + " to " + endDateTime.getHours() + ':' + (endDateTime.getMinutes() < 10 ?
                            '0' + endDateTime.getMinutes() : endDateTime.getMinutes()) + "!";
                    self.openDialog(message).open();
                    self.validateOk = false;
                } else {
                    acceptPicker = acceptPicker + 1;
                }
                if (acceptPicker == 2) {
                    self.$('input[id=timepicker-24]').val((dateTimeNowExtend.getHours() < 10 ? '0' +
                        dateTimeNowExtend.getHours() : dateTimeNowExtend.getHours()) + ':' + (
                            dateTimeNowExtend.getMinutes() < 10 ? '0' + dateTimeNowExtend.getMinutes() :
                                dateTimeNowExtend.getMinutes()));
                }

                // console.log('startDateTime', startDateTime);
                // console.log('endDateTime', endDateTime);
                // console.log('pickerDateTime', pickerDateTime);
                // console.log('startDateTimeExtend', startDateTimeExtend);
                // console.log('dateTimeNowPlus', dateTimeNowPlus);
            },
            openPopOver: function () {
                var dynamicPopover = app.popover.create({
                    targetEl: 'a.dynamic-popover',
                    content: '<div class="popover">' +
                        '<div class="popover-inner">' +
                        '<div class="block">' +
                        '<p><span style="font-size: 20px"><b>Collection time</b></span></p>' +
                        '<p>Choose the time you want to receive the goods!</p>' +
                        '<p style="text-align: center"><a href="#" class="link popover-close">Close</a></p>' +
                        '</div>' +
                        '</div>' +
                        '</div>',
                    // Events
                    on: {
                        open: function (popover) {
                            //console.log('Popover mo');
                        },
                        opened: function (popover) {
                            //console.log('Popover da mo');
                        },
                    }
                });
                return dynamicPopover;
            },
            getCurrentLoginInformation: function () {
                var self = this;
                app.request.get(window.config.url + 'api/services/app/Session/GetCurrentLoginInformations',
                    function (suc) {
                        let response = JSON.parse(suc)
                        //console.log(response.result.user)
                        if (response.result.user == null || response.result.user == 'null') {
                            app.utils.custom.removeCookie();
                            app.views.current.router.navigate('/signin');
                        } else {
                            localStorage.setItem('WOKPPL_mobile', response.result.user.userName);
                            localStorage.setItem('WOKPPL_name', response.result.user.name);
                            localStorage.setItem('WOKPPL_email', response.result.user.emailAddress);
                            if (response.result.canteen != null && response.result.canteen != 'null') {
                                if (response.result.canteen.tax != null && response.result.canteen.tax !=
                                    'null') {
                                    self.$setState({
                                        gst: response.result.canteen.tax.value,
                                        gstType: response.result.canteen.tax.type //inclusive, exclusive
                                    })
                                    localStorage.setItem('WOKPPL_gst', response.result.canteen.tax.value);
                                    localStorage.setItem('WOKPPL_gstType', response.result.canteen.tax.type);
                                } else {
                                    self.gst = 0;
                                    self.gstType = 'exclusive';
                                }
                            } else {
                                self.gst = 0;
                                self.gstType = 'exclusive';
                            }
                        }
                    },
                    function (err) {
                        console.log(err)
                    })
            },
            loadCreditCards: function () {
                var self = this;
                //loaf list card
                app.request.get(window.config.url + 'api/services/app/Card/GetAllCards',
                    function (suc) {
                        //console.log('list card success');
                        if (suc) {
                            let response = JSON.parse(suc);
                            //console.log(response);
                            if (response.result.items) {
                                self.$setState({
                                    listCard: response.result.items
                                });
                                let card = response.result.items.find((el) => {
                                    if (el.isDefault) return el;
                                    else return null;
                                });
                                self.paymentMethodId = card == null ? 0 : card.id
                            }
                        }
                    },
                    function (err) {
                        let response = JSON.parse(err);
                        console.log('info error');
                        console.log(response);
                    });
            },
            clickHandle: function (id, isDefault) {
                var self = this;
                //console.log(id, isDefault)
                if (!isDefault) {
                    //uncheck others checkbox
                    $('input[type="checkbox"]').on('change', function () {
                        $('input[type="checkbox"]').not(this).prop('checked', false);
                    });
                    //refresh listCard
                    let list = self.listCard
                    list.forEach(element => {
                        if (element.id != id) element.isDefault = false;
                        else element.isDefault = true;
                    });

                    self.$setState({
                        listCard: list,
                        paymentMethodId: id
                    })
                    //set Default card
                    app.request.post(window.config.url + 'api/services/app/Card/SetDefault?id=' + id,
                        function (suc) {
                            let response = JSON.parse(suc);
                            //console.log(response)
                        },
                        function (err) {
                            let response = JSON.parse(err.response);
                            console.log(response);
                            var dialog = app.dialog.create({
                                content: '<div class="block no-margin margin-top text-align-center"><i class="fa-stack fa-3x"><span class="fas fa-stack-2x fa-circle text-color-red"></span><span class="fas fa-stack-1x fa-inverse fa-times"></span></i><p>' + response.error.message + '.</p></div>',
                                buttons: [
                                    {
                                        text: 'Retry',
                                        bold: true,
                                        color: 'red'
                                    }
                                ]
                            });
                            dialog.open();
                        })
                }

            },
        },
        on: {
            pageInit: function () {
                var self = this;
                localStorage.setItem("currentView", "orders-cart");
                //get current login for GST info
                self.getCurrentLoginInformation();
                //API GetPointRateInfo
                self.getStatusRewardOint();
                self.loadCreditCards();
                //self.initializeTimepicker24()
                let cartTemp = JSON.parse(localStorage.getItem('cartItems'));
                let disableCheckout = JSON.parse(localStorage.getItem('disableCheckout'));
                if (disableCheckout != null) {
                    self.$setState({
                        disableCheckout: false,
                    })
                } else {
                    self.$setState({
                        disableCheckout: true,
                    })
                }
                //console.log('disableCheckout', disableCheckout);
                //console.log('cartTemp:', cartTemp);
                let tempString = [];
                if (cartTemp != null)
                    for (let i = 0; i < cartTemp.items.length; i++) {
                        cartTemp.items[i].editornew = false;
                        cartTemp.items[i].indexProduct = i + '-' + cartTemp.items[i].id;
                    }

                self.$('input[type=checkbox]').change(function () {
                    if ($(this).is(":checked")) {
                        self.$setState({
                            checkToggle: true,
                            //discount: self.discount - self.redeem,
                            grandTotal: self.gstType == 'inclusive' ? (cartTemp.total - self
                                .redeem > 0 ? cartTemp.total - self.redeem : 0) : (cartTemp
                                    .total * (1 + Number(self.gst) / 100) - self.redeem > 0 ?
                                    cartTemp.total * (1 + Number(self.gst) / 100) - self.redeem : 0
                                ),
                        })

                    } else {
                        self.$setState({
                            checkToggle: false,
                            //discount: self.discount + self.redeem,
                            grandTotal: self.gstType == 'inclusive' ? cartTemp.total : cartTemp
                                .total * (1 + Number(self.gst) / 100)
                        })
                    }
                    //console.log(self.checkToggle)
                })
                self.$('input[type=radio]').change(function () {
                    //console.log($(this).val())
                    self.newOrder.type = $(this).val();
                });

                let sessionTemp = JSON.parse(localStorage.getItem('listOrderSession'));
                let orderDateTemp = JSON.parse(localStorage.getItem('listOrderDate'));
                // console.log('sessionTemp', sessionTemp);
                // console.log('orderDateTemp', orderDateTemp);
                // console.log('orderDateTemp convert', new Date(orderDateTemp));

                self.$('input[id=timepicker-24]').click(function () {
                    self.$setState({
                        //tt tm ci ny. Thi thong vn ko bm close c: true >> false
                        disableCloseButton: false,
                    })
                });

                let arrStarTime = sessionTemp.startTime.split(':');
                let arrEndTime = sessionTemp.endTime.split(':')

                if (cartTemp != null) {
                    self.$setState({
                        updateCartList: cartTemp,

                        quantity: cartTemp.quantity,
                        total: self.gstType == 'inclusive' ? cartTemp.total * (1 - self.gst / 100) :
                            cartTemp.total,
                        listOrderDate: cartTemp.listOrderDate,
                        listOrderSession: cartTemp.listOrderSession,
                        orderSessionName: cartTemp.listOrderSession.name,
                        orderSessionTime: cartTemp.listOrderSession.startTime + " - " + cartTemp
                            .listOrderSession.endTime,
                        grandTotal: self.gstType == 'inclusive' ? cartTemp.total : cartTemp.total * (1 +
                            Number(self.gst) / 100),
                        gstAmount: cartTemp.total * (Number(self.gst) / 100),
                        hourStart: arrStarTime[0],
                        hourEnd: arrEndTime[0],
                        minuteStart: arrStarTime[1],
                        minuteEnd: arrEndTime[1]
                    })
                }
                //console.log(cartTemp.items)

                if (self.gstType == 'inclusive') {
                    let temp = cartTemp.items;
                    temp.forEach(function (el) {
                        el.price = el.price * (1 - self.gst / 100);
                    })
                    self.$setState({
                        productList: temp
                    })
                } else self.$setState({
                    productList: cartTemp.items
                })
                //console.log('productList', self.productList, self.total, self.grandTotal);
                self.showTimePicker();

                $(document).ready(function () {
                    self.openPopOver().open();
                });
                $('.dynamic-popover').click(function () {
                    self.openPopOver().open();
                });
            }
        }
    }
</script>